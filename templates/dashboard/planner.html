{% extends 'base.html' %}

{% block title %}Planner - Daily Routine Planner{% endblock %}

{% block extra_css %}
<style>
:root {
  --primary: #0F766E;
  --primary-light: #5EEAD4;
  --primary-dark: #115E59;
  --bg: #F8FAFC;
  --card-bg: #FFFFFF;
  --border: #E2E8F0;
  --text: #1E293B;
  --text-light: #64748B;
  --done: #F0FDF4;
  --ibadah: #F0F9FF;
}

.container-planner {
  max-width: 980px;
  margin: 0 auto;
}

.header-card { text-align:center; margin-bottom:20px; padding:20px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); border-radius:12px; color:#fff }
.stats-card, .routine-container { background:var(--card-bg); border-radius:12px; padding:18px; box-shadow:0 4px 6px rgba(0,0,0,0.08); border:1px solid var(--border); margin-bottom:20px }
.routine { display:grid; gap:12px }
.task { display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; border:1px solid var(--border) }
.task.completed { background:var(--done); border-color:#BBF7D0 }
.task.ibadah { background:var(--ibadah); border-left:4px solid var(--primary) }
.task-checkbox { width:20px; height:20px; border-radius:6px; border:2px solid var(--border); cursor:pointer; display:flex; align-items:center; justify-content:center }
.task-checkbox.checked { background:var(--primary); border-color:var(--primary) }
.task-checkbox.checked::after { content:'âœ“'; color:#fff; font-weight:700 }
.task-time { min-width:110px; color:var(--primary-dark); font-weight:600 }
.task-content { flex:1 }

@media (max-width:768px){ .container-planner{padding:10px} .task{flex-direction:column;align-items:flex-start} }
</style>
{% endblock %}

{% block content %}
<div class="container-planner">
  <div class="header-card">
    <h1>ðŸ“‹ Daily Routine Planner</h1>
    <div id="current-date">{{ today }}</div>
  </div>

  <div class="stats-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <strong>Today's Progress</strong>
        <div id="progress-percentage">0%</div>
      </div>
      <div>
        <button class="btn btn-outline-secondary" onclick="saveData()">ðŸ’¾ Save</button>
        <button class="btn btn-primary" onclick="showExportModal()">ðŸ“¤ Send</button>
      </div>
    </div>
    <div style="margin-top:12px;">
      <div class="progress" style="height:10px;background:#E6EEF8;border-radius:6px;">
        <div id="progress-fill" style="width:0%;height:10px;background:linear-gradient(90deg,var(--primary-light),var(--primary));border-radius:6px;"></div>
      </div>
      <div style="margin-top:6px;color:var(--text-light);"> <span id="completed-count">0</span> of <span id="total-count">0</span> tasks completed</div>
    </div>
  </div>

  <div class="routine-container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h4>Your Daily Tasks</h4>
      <div><a href="{% url 'routine_create' %}" class="btn btn-outline-primary">+ New Routine</a></div>
    </div>

    <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <input id="new-task-time" class="form-control" placeholder="Time (e.g. 07:00)" style="max-width:140px;padding:8px;border:1px solid var(--border);border-radius:6px;" />
      <input id="new-task-desc" class="form-control" placeholder="Task description" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px;" />
      <label style="display:flex;align-items:center;gap:6px;color:var(--text-light);"><input id="new-task-ibadah" type="checkbox" /> Ibadah</label>
      <button class="btn btn-primary" onclick="createTask()" style="padding:8px 12px;border-radius:6px;">+ Add</button>
    </div>

    <div class="routine">
      {% for task in routine.tasks.all %}
      <div class="task {% if task.is_completed %}completed{% endif %} {% if task.is_ibadah %}ibadah{% endif %}" data-id="{{ task.pk }}">
        <div class="task-checkbox {% if task.is_completed %}checked{% endif %}" onclick="toggleTask(this)"></div>
        <div class="task-time">{{ task.time }}</div>
        <div class="task-content">{{ task.description }} <small style="margin-left:8px;color:var(--text-light);">{{ task.category.name|default:'Regular' }}</small></div>
      </div>
      {% empty %}
      <div class="alert alert-info">No tasks for today. Create a routine to add tasks.</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Send Report Modal -->
<div class="modal fade" id="sendReportModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Send Daily Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="recipient-email" class="form-label">Recipient Email</label>
        <input id="recipient-email" type="email" class="form-control" placeholder="you@example.com">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="sendReport()">Send</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const currentDateEl = document.getElementById('current-date');
  if(currentDateEl){ currentDateEl.textContent = new Date().toLocaleDateString(); }
  const total = document.querySelectorAll('.task').length;
  document.getElementById('total-count').textContent = total;
  updateProgress();
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateProgress(){
  const taskEls = document.querySelectorAll('.task');
  const completed = Array.from(taskEls).filter(t => t.classList.contains('completed')).length;
  const total = taskEls.length || 1;
  const percent = Math.round((completed/total)*100);
  document.getElementById('progress-percentage').textContent = percent + '%';
  document.getElementById('progress-fill').style.width = percent + '%';
  document.getElementById('completed-count').textContent = completed;
}

async function toggleTask(checkboxEl){
  const taskEl = checkboxEl.parentElement;
  const taskId = taskEl.getAttribute('data-id');
  const csrftoken = getCookie('csrftoken');
  try{
    const res = await fetch('{% url "toggle_task" %}', {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
      body: JSON.stringify({task_id:taskId}),
      credentials:'same-origin'
    });
    const data = await res.json();
    if(data.success){
      if(data.task_completed){ taskEl.classList.add('completed'); checkboxEl.classList.add('checked'); }
      else{ taskEl.classList.remove('completed'); checkboxEl.classList.remove('checked'); }
      updateProgress();
    } else {
      alert('Could not update task: ' + (data.error||'unknown'));
    }
  }catch(err){ alert('Error: '+err.message); }
}

function showExportModal(){ var m = new bootstrap.Modal(document.getElementById('sendReportModal')); m.show(); }
function hideExportModal(){ var m = bootstrap.Modal.getInstance(document.getElementById('sendReportModal')); if(m) m.hide(); }

async function sendReport(){
  const recipient = document.getElementById('recipient-email').value.trim();
  if(!recipient){ alert('Enter recipient email'); return; }
  const taskEls = document.querySelectorAll('.task');
  const tasksPayload = Array.from(taskEls).map(t=>({ time: t.querySelector('.task-time')?.textContent||'', text: t.querySelector('.task-content')?.textContent||'', category: t.querySelector('.task-content small')?.textContent||'', status: t.classList.contains('completed')?'Completed':'Pending' }));
  const payload = { email: recipient, date: new Date().toLocaleDateString(), subject: 'Daily Routine Report', tasks: tasksPayload };
  const csrftoken = getCookie('csrftoken');
  try{
    const res = await fetch('{% url "send_report" %}', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body: JSON.stringify(payload), credentials:'same-origin' });
    const data = await res.json();
    if(data.success){ hideExportModal(); alert('Report sent'); }
    else alert('Send failed: '+(data.error||'unknown'));
  }catch(err){ alert('Error: '+err.message); }
}

function saveData(){ showToast('Saved locally'); }
function showToast(msg){ alert(msg); }

// Create new task via API and append to DOM
async function createTask(){
  const time = document.getElementById('new-task-time').value.trim();
  const desc = document.getElementById('new-task-desc').value.trim();
  const is_ibadah = document.getElementById('new-task-ibadah').checked;
  if(!desc){ alert('Enter task description'); return; }
  const payload = { time: time, description: desc, is_ibadah: is_ibadah };
  const csrftoken = getCookie('csrftoken');
  try{
    const res = await fetch('{% url "create_task" %}', { method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body: JSON.stringify(payload), credentials:'same-origin' });
    const data = await res.json();
    if(data.success){
      const t = data.task;
      const container = document.querySelector('.routine');
      const div = document.createElement('div');
      div.className = 'task' + (t.is_completed? ' completed':'') + (t.is_ibadah? ' ibadah':'');
      div.setAttribute('data-id', t.id);
      div.innerHTML = `<div class="task-checkbox ${t.is_completed? 'checked':''}" onclick="toggleTask(this)"></div><div class="task-time">${t.time||''}</div><div class="task-content">${t.description} <small style="margin-left:8px;color:var(--text-light);">${t.category||'Regular'}</small></div>`;
      container.appendChild(div);
      document.getElementById('new-task-time').value=''; document.getElementById('new-task-desc').value=''; document.getElementById('new-task-ibadah').checked=false;
      const total = document.querySelectorAll('.task').length; document.getElementById('total-count').textContent = total; updateProgress();
    } else {
      alert('Create failed: ' + (data.error||'unknown'));
    }
  }catch(err){ alert('Error: '+err.message); }
}
</script>
{% endblock %}
